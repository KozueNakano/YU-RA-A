# YU-RA-A

## 装置概要
ライト部分からモーターを廃して、レール末端に移動させ、ベルトで駆動できるようにした試作です。
ライト可動部分への電力と信号の供給は、ベルトに添わせたケーブルを通して行い、ケーブルは可動に伴って巻取、放出が行われるようになっています。
モーター、LEDの制御は、オープンソースのCNCコントローラーであるGRBLの派生プロジェクト、GRBL For ESP32を元にしています。
詳細な使用方法や制御方法は、こちらを参照してください。  
https://github.com/bdring/Grbl_Esp32
https://github.com/bdring/Grbl_Esp32/wiki


## 各部の名称、用途
- 回路BOX部分
- ライト可動部分
- モーター部分

## 取扱い方概要
レール部分を壁面に取り付け、固定して使用してください。

## セットアップ方法
本試作はPCもしくはスマートフォンからの制御を必要とします。  
下記セットアップを行い、動作を確認してください。
### HWのセットアップ
- 固定
#### ケーブルの接続
動作確認を行う前に、各部のケーブルを接続する必要があります。
- モーターケーブル
モーター部分から出ているケーブルのうち、赤、青、緑、黒の順の4線ケーブルを、回路ボックスのモーターコネクタに差し込んでください。
- LEDケーブル
モーター部分から出ているケーブルのうち、x,x,x,xの順の4線ケーブルを、回路ボックスのLEDコネクタに差し込んでください。
- リミットスイッチケーブル
モーター部分から出ているケーブルのうち、白、白の2線ケーブルを、回路ボックスのリミットスイッチコネクタに差し込んでください。
- 電源ケーブル
同梱のACアダプタをコンセントに挿し、回路ボックスのDCジャックに、ACアダプタのDCジャックを差し込んでください。
**必ず、USBケーブルの接続よりも先にACアダプタを接続してください。**
- USBケーブル
回路ボックス側面のUSBポートと、PCのUSBポートを、付属のUSBケーブルで接続してください。
### 操作方法
GRBL for ESP32は、wifiでの操作ができるようになっています。  
動作確認に使用することができます。  
UIには、下記を使用しています。  
[https://github.com/bdring/Grbl_Esp32/wiki/ESP3D-Web-UI-for-Grbl_ESP32](https://github.com/bdring/Grbl_Esp32/wiki/ESP3D-Web-UI-for-Grbl_ESP32)
- wifiアクセスポイントへの接続
スマートフォン、もしくはPCで、GRBLの立ち上げているアクセスポイントに接続します。  
アクセスポイント名は`GRBL_ESP`です。
- ブラウザからのアクセス
アクセスポイントに接続すると、自動でコントロール画面へアクセスします。表示されない場合は、ブラウザを立ち上げ、次のアドレスへアクセスしてください。
[http://192.168.0.1/](http://192.168.0.1/)

- 操作方法
ライトの移動に関しては、GRBLのX軸に割り当てられています。UIの、HomeXボタンを押すと、ライト可動部分がリミットスイッチに当たるまで動き、レールの端の原点を探します。  
その後、X軸のjogボタンを押すと、可動部分を動かすことができます。  
ライトは、コマンド入力部分にコマンドを入力して送信することで制御することができます。  
ch0とch1にそれぞれ割り当てられています。  
下記コマンドで、LED ch0とch1がそれぞれ50%で点灯します。  
```
M67 E0 Q50
M67 E1 Q50
```

- コントローラーの状態
GRBLコントローラーの状態には、Alarm状態とIdle状態があります。  
原点の探索が行われていない状態や、可動範囲を超えた移動指示を受けたあとは、Alarm状態になりますので、UI上のAlarmボタンを押して解除するまでは動かすことができません。Alarmボタンを押すとIdle状態になり、モーター、LEDを動かすことができるようになります。

### PCからの認識
例として、macBookにインストールしたArduino IDEと本試作を接続し、制御する方法を記載します。
- COMポート番号の確認と設定
    - USBケーブルがPCと回路ボックスに接続されていることを確認します。
    - Arduino IDEを立ち上げ、シリアルポートの欄から、回路ボックスを接続したときに増えているシリアルポートを選択してください。USBポートに接続されているのが、回路ボックスのみなら、blueToothでないほうの接続先が本試作のポートになります。
    - Arduino IDEのシリアルモニターを開き、BaudLateを115200,改行記号をCRおよびLFに設定してください。
    - シリアルモニターに`M67 E0 Q50`などのコマンドを入力し、送信を押します。無事にコマンドが送信できた場合、`ok`の文字が返送されてきます。
### シリアルコマンドでの動作確認
GRBLはシリアルポートからのコマンド入力で状態や動きを制御できます。  
詳細なコマンドの使い方については、下記のwikiを参照してください。  
本試作で使用しているGRBL for ESP32を含め、CNCコントローラーはGコードと呼ばれる簡単なコマンドで動作を制御します。  

本試作で使用しているボードのwiki
[https://github.com/bdring/Grbl_Esp32/wiki](https://github.com/bdring/Grbl_Esp32/wiki)
もととなったGBRLプロジェクトのwiki  
GRBLの基本的な使い方について確認できます。
[https://github.com/gnea/grbl/wiki](https://github.com/gnea/grbl/wiki)
Gコードについての解説
[http://linuxcnc.org/docs/html/gcode.html](http://linuxcnc.org/docs/html/gcode.html)
[https://wiki.shapeoko.com/index.php/G-Code](https://wiki.shapeoko.com/index.php/G-Code)

今回の用途で使用するであろう、代表的なコマンドの使用方法を下記します。

- Alarm解除
`X`
ホーミング(原点の探索)が行われていなかったり、可動範囲を超えて動作させるようなコマンドを発行したりすると、機械の損傷を防ぐために、自動的にAlarmモードに入ります。再度動かすには、UIもしくは上記のコマンドでAlarmを解除する必要があります。
- X軸ホーミング
`HX`
X軸の原点を探索します。リミットスイッチに当たるまで、モーターを動かし、スイッチにあたった場所を0mm地点として記録します。原点の記録は電源を切ると失われるので、回路の電源を入れるたびにX軸ホーミングを行ってください。
- X軸動作
`G00 X100`
X軸に割り当てられている、LED可動部分を動かすには、`G00`コードを使います。  　 
`X100`の部分は、X軸を原点から100mmの位置に移動させることを示しています。  
`aaa`の部分は、移動速度を示しています。単位はmm/minで、xxxmm/min以上の値は物理的な制約があるので、後述のマシン定義にてリミットをかけてあります。  
- LED動作
`M67 E0 Q50`
LED信号の操作にはM67コマンドを使用します。 ExはLED信号のch番号です。0と1が使用できます。Qの部分は、LED信号のデューティー比を示しています。0~100%を指定できます。

### Pythonでの操作方法
- pythonの動作確認用コードのインストール
(URL)[URL]
上記のリポジトリをcloneして、python3のスクリプトを実行します。  
適宜pip install などで、インストールされていないパッケージをインストールしてください。  
シリアルポート番号はスクリプト内にハードコードされていますので、実際の接続状況に応じて変更してください。  

操作の流れとしては、  
1. GRBLが接続されると、最初はマシン定義などの機械の状態をレポートするので、その間はコマンドを受け付けないため、3秒ほど待機する
2. アラームを解除する
3. X軸をホーミングする
4. LEDの明るさを設定する
5. 指定した座標までX軸を移動する
6. 戻る
7. 以下ループ
という流れになっています。  
詳細な注意事項についてはスクリプト内にコメントで記載しました。

- 動作確認方法
    - 下記手順でpythonスクリプトの動作確認ができます。
    1. 本試作の配線などの接続をすべて行う
    2. シリアルポートをArduinoIDEで確認し、スクリプト内のシリアルポートの記載をあわせる。
    3. スクリプトを実行する
## 応用方法
### LEDの接続方法、注意点
回路ボックスのLEDコネクタは、電源、GND、ch0PWM信号、ch1PWM信号を出力しています。  
PWM信号は信号用のポートに接続されていますので、実際のLEDを駆動する際には、この信号をFETやLEDドライバに入力して、電力のスイッチングはそれらに行ってもらう必要があります。  
テスト用に、FETで制御する基板を同梱しています。
### ケーブルのテンション調整方法
本試作では、ライト可動部分の動きにあわせて、ケーブルを送り出したり巻き取ったりしていますが、巻取ドラムにケーブルを巻きつけていくと、ケーブルの厚みで直径が変わってしまい、巻取速度に変化が出てしまいます。そのままですとケーブルがたわんだり、突っ張ったりするので、ケーブルの巻取ドラム内部にぜんまいを入れ、ある程度の変化に対応できるようにしています。  
通常の使用時にはケーブルが垂れ下がらない程度のテンションがかかっている状態にする必要があります。  
装置を分解したり、レールの長さを変更した場合などには、テンションの再調整が必要です、下記手順で垂れ下がらない程度に調整してください。  
1. ケーブルをすべて巻き取る
GRBLの制御で、X軸をホーミングして原点に戻して、ケーブルをできるだけ巻き取った状態にしてください。
安全のため、ACアダプタのDCジャックを抜き取り、電源を切ってください。
2. モータープーリーカバーを開ける
モーター部のカバーのうち、レール側の上側のカバーのみを取り外します。
3. ベルトをフリーにする
ライト可動部分を動かしているベルトをゆるめ、モーターと噛み合わないようにします。  
具体的には、レール末端のベルトテンショナーを回して、ベルトをめいいっぱい緩めるか、ライト可動部分とベルト端部を固定しているインシュロックを切り、ベルトを緩めます。
4. 分解する
レールを替えたり、　分解したりなどの操作をします。
このとき、**ベルトがモーターを回してしまわないようにします。**
5. モータープーリーを固定する
電源を入れることで、モーターを固定してプーリーが動かないようにします。
7. ケーブルを引き出す
モーターを固定したまま、ケーブルを引き出していき、所望のテンションになった場所で止めます。
8. ベルトをモーターのプーリーに固定する。
ゆるめたベルトを、モーターのプーリーにかけて、固定し、ベルトの張りも調整します。

### レール長の変更方法
レールは所望の長さのものに交換することができます。  
レールを取り付けているボルトをゆるめ交換してください。その際、上記のケーブルの張りの調整と同時に行ってください。
#### リミット設定方法
本試作では、レールのモーター側にはリミットスイッチが設置してありますが、逆側にはリミットスイッチは設置していません。  
GRBLの設定で、ソフトウェア的に可動範囲の制限を行っています。  
レールの長さを変更した際には、この可動範囲の設定も変更する必要があります。  
- 回路ボックスにACアダプタを接続してGRBLを起動して、wifi接続と、ブラウザでの動作確認のUIの表示を行ってください。
- UIの`GRBL`のタブを開き、$130 X MaxTravelの項目を、実際のレールの可動範囲か、安全をみてすこし小さく設定してください。
### GRBL設定
- GRBLマシン定義
GRBLは物理的な大きさや機能の異なる機械を制御するため、マシンを定義することができます。本試作では変更する必要はないと思われますが、下記のようにマシン定義ファイルを入れ替えてファームウェアを焼き直すことで変更が可能です。

[https://github.com/bdring/Grbl_Esp32/wiki/Custom-Machine-Functions](https://github.com/bdring/Grbl_Esp32/wiki/Custom-Machine-Functions)
- GRBL設定
マシン定義ファイルとは別に、GRBLには不揮発性の設定項目があり、コマンドや、web UIから設定可能です。  
レールの長さの変更時には、この設定項目の一つである、X MAX Travelを設定してください。
[https://github.com/bdring/Grbl_Esp32/wiki/Settings](https://github.com/bdring/Grbl_Esp32/wiki/Settings)
### python
- シリアルポートの設定
毎回シリアルポートの設定を書き換えて実行するのが面倒であれば、次のリポジトリを参考に実行時にCUIから設定するのもよいかもしれません。
[https://gist.github.com/TonyMooori/bd276abc8d149ef33225](https://gist.github.com/TonyMooori/bd276abc8d149ef33225)


## 設計資料
### 主だった部品
- コントローラー
GRBL for ESP32をベースに、基板については本試作用に設計しています。回路の詳細は回路図を参照してください。
- レール
レールは、misumiの5シリーズNFSB5-2020を使用しています。同じラインナップであれば交換が可能です。  
(https://jp.misumi-ec.com/vona2/detail/110302683830/?HissuCode=NFSB5-2020-1000)[https://jp.misumi-ec.com/vona2/detail/110302683830/?HissuCode=NFSB5-2020-1000]
- ベルト
ベルトは、GT2 6mm幅を使用しています。 歯のピッチは2mmです。
- コネクタ
回路図ボックス、モーターなどの接続に使用しているコネクタは、JSTのXHコネクタです。ケーブルなどを作成される場合はXHコネクタで作成して接続してください。
[https://www.jst-mfg.com/product/detail.php?series=277](https://www.jst-mfg.com/product/detail.php?series=277)
- ACアダプタ
ACアダプタは12V2A以上のものを使用してください。LEDを使用する場合は、LEDの消費電流も見込んで余裕のあるACアダプタを使用してください。
### HW-BOM
### 3DCAD
### 回路図
### 回路、基板データ
### 回路-BOM
